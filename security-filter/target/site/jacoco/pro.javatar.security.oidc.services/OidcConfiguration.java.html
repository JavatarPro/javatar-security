<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OidcConfiguration.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">security-filter</a> &gt; <a href="index.source.html" class="el_package">pro.javatar.security.oidc.services</a> &gt; <span class="el_source">OidcConfiguration.java</span></div><h1>OidcConfiguration.java</h1><pre class="source lang-java linenums">package pro.javatar.security.oidc.services;

import pro.javatar.security.oidc.model.UserKey;
import pro.javatar.security.oidc.utils.StringUtils;
import pro.javatar.security.oidc.utils.UrlResolver;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Service
<span class="fc" id="L21">public class OidcConfiguration implements OAuth2Configuration, InitializingBean {</span>

<span class="fc" id="L23">    private static final Logger logger = LoggerFactory.getLogger(OidcConfiguration.class);</span>

    public static final String REDIRECT_URI_PLACEHOLDER = &quot;{redirect_uri}&quot;;
    public static final String CLIENT_ID_PLACEHOLDER = &quot;{client_id}&quot;;
    public static final String REALM_PLACEHOLDER = &quot;{realm}&quot;;
    public static final String TOKEN_ENDPOINT =
            &quot;/auth/realms/&quot; + REALM_PLACEHOLDER + &quot;/protocol/openid-connect/token&quot;;
    public static final String LOGOUT_ENDPOINT =
            &quot;/auth/realms/&quot; + REALM_PLACEHOLDER + &quot;/protocol/openid-connect/logout?redirect_uri=&quot;;
    public static final String AUTHORIZATION_ENDPOINT = &quot;/auth/realms/&quot; + REALM_PLACEHOLDER
            + &quot;/protocol/openid-connect/auth?client_id=&quot; + CLIENT_ID_PLACEHOLDER + &quot;&amp;redirect_uri=&quot;
            + REDIRECT_URI_PLACEHOLDER + &quot;&amp;response_type=code&amp;scope=openid&quot;;

    @Value(&quot;${security.oidc.identity_provider_host:}&quot;)
    private String identityProviderHost;

    @Value(&quot;${security.oidc.authorization_endpoint:&quot; + AUTHORIZATION_ENDPOINT + &quot;}&quot;)
    private String authorizationEndpoint;

    @Value(&quot;${security.oidc.logout_endpoint:&quot; + LOGOUT_ENDPOINT + &quot;}&quot;)
    private String logoutEndpoint;

    @Value(&quot;${security.oidc.token_endpoint:&quot; + TOKEN_ENDPOINT + &quot;}&quot;)
    private String tokenEndpoint;

    @Value(&quot;${security.oauth2.client_id:}&quot;)
    private String clientId;

    @Value(&quot;${security.oauth2.client_secret:}&quot;)
    private String clientSecret;

    @Value(&quot;${security.oauth2.username:}&quot;)
    private String username;

    @Value(&quot;${security.oauth2.password:}&quot;)
    private String userPassword;

<span class="fc" id="L60">    private Map&lt;UserKey, String&gt; runOnBehalfOfUsers = new ConcurrentHashMap&lt;&gt;();</span>

<span class="fc" id="L62">    @Value(&quot;${security.oidc.encodeRedirectUri:true}&quot;)</span>
    private boolean encodeRedirectUri = true;

<span class="fc" id="L65">    @Value(&quot;${security.oidc.skipRefererCheck:false}&quot;)</span>
    private boolean skipRefererCheck = false;

<span class="fc" id="L68">    @Value(&quot;${security.cors.enable:false}&quot;)</span>
    private boolean corsFilterEnable = false;

    private String scope;

    /**
     * All public keys are stored in redis db.
     * &lt;p&gt;
     * See {@link PublicKeyCacheService} for more details.
     */
    @Deprecated
    @Value(&quot;${security.oauth2.publicKey:}&quot;)
    private String publicKey;

    @Value(&quot;${security.oidc.checkTokenIsActive:true}&quot;)
    public boolean checkIsActive;

    @Value(&quot;${security.oidc.checkTokenType:true}&quot;)
    public boolean checkTokenType;

    @Value(&quot;${security.oidc.useReferAsRedirectUri:false}&quot;)
    public boolean useReferAsRedirectUri;

    @Value(&quot;${security.oidc.defaultRealm:mservice}&quot;)
    public String defaultRealm;

    @Value(&quot;${security.oauth2.tokenShouldBeRefreshed:75}&quot;)
    private int tokenShouldBeRefreshed;

    @Value(&quot;${security.oidc.excludeValidationRealm:mservice}&quot;)
    public String excludeValidationRealm;

    @Value(&quot;${security.oidc.OidcAuthenticationHttpClientInterceptor.enable:true}&quot;)
    public boolean securityInterceptorEnable;

<span class="fc" id="L103">    private final FilterOptionConverter filterOptionConverter = new FilterOptionConverter();</span>
<span class="fc" id="L104">    private final UrlResolver interceptorUrlResolver = new UrlResolver();</span>
<span class="fc" id="L105">    private final UrlResolver urlResolver = new UrlResolver();</span>

    @Value(&quot;${security.oidc.OidcAuthenticationHttpClientInterceptor.applyUrlRegex:/.*}&quot;)
    public void setSecurityInterceptorApplyUrlRegex(String applyUrlRegex) {
<span class="fc" id="L109">        interceptorUrlResolver.setFilterApplyUrlRegex(applyUrlRegex);</span>
<span class="fc" id="L110">    }</span>

    @Value(&quot;#{'${security.oidc.OidcAuthenticationHttpClientInterceptor.filterApplyUrlList:}'.split(',')}&quot;)
    public void setSecurityInterceptorApplyUrlList(List&lt;String&gt; filterApplyUrlList) {
<span class="fc" id="L114">        this.interceptorUrlResolver.setFilterApplyUrls(filterOptionConverter.convertList(filterApplyUrlList));</span>
<span class="fc" id="L115">    }</span>

    @Override
    public UrlResolver getInterceptorUrlResolver() {
<span class="nc" id="L119">        return interceptorUrlResolver;</span>
    }

    @Override
    public UrlResolver getUrlResolver() {
<span class="fc" id="L124">        return urlResolver;</span>
    }

    @Override
    @Value(&quot;${security.oidc.filterApplyUrlRegex:\\/.*}&quot;)
    public void setFilterApplyUrlRegex(String filterApplyUrlRegex) {
<span class="fc" id="L130">        urlResolver.setFilterApplyUrlRegex(filterApplyUrlRegex);</span>
<span class="fc" id="L131">    }</span>

    @Override
    @Value(&quot;#{'${security.oidc.filterApplyUrlList:}'.split(',')}&quot;)
    public void setFilterApplyUrlList(List&lt;String&gt; filterApplyUrlList) {
<span class="fc" id="L136">        urlResolver.setFilterApplyUrls(filterOptionConverter.convertList(filterApplyUrlList));</span>
<span class="fc" id="L137">    }</span>

    @Override
    @Value(&quot;#{'${security.oidc.filterIgnoreUrlList:}'.split(',')}&quot;)
    public void setFilterIgnoreUrlList(List&lt;String&gt; filterIgnoreUrlList) {
<span class="fc" id="L142">        urlResolver.setFilterIgnoreUrls(filterOptionConverter.convertList(filterIgnoreUrlList));</span>
<span class="fc" id="L143">    }</span>

<span class="fc" id="L145">    @Value(&quot;${security.oidc.AuthenticationJwtBearerTokenAwareFilter.enable:true}&quot;)</span>
    private boolean jwtBearerFilterEnable = false;

<span class="fc" id="L148">    @Value(&quot;${security.oidc.AuthenticationJwtBearerTokenAwareFilter.anonymousAllowed:false}&quot;)</span>
    private boolean anonymousAllowed = false;

<span class="fc" id="L151">    @Value(&quot;${security.oidc.AuthenticationJwtBearerTokenAwareFilter.jwtBearerTokenRequired:true}&quot;)</span>
    private boolean jwtBearerTokenRequired = true;

    // @Value(&quot;${security.oidc.AuthenticationJwtBearerTokenAwareFilter.jwtBearerTokenOtherAuthenticationAllowed:false}&quot;)
<span class="fc" id="L155">    private boolean jwtBearerTokenOtherAuthenticationAllowed = false;</span>

    public boolean isCorsFilterEnable() {
<span class="fc" id="L158">        return corsFilterEnable;</span>
    }

    public void setCorsFilterEnable(boolean corsFilterEnable) {
<span class="nc" id="L162">        this.corsFilterEnable = corsFilterEnable;</span>
<span class="nc" id="L163">    }</span>

    @Override
    public void afterPropertiesSet() throws Exception {
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (StringUtils.isBlank(username)) {</span>
<span class="fc" id="L168">            logger.warn(&quot;default username must be specified for cases when you run on behalf of application user&quot;);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        } else if (StringUtils.isNotBlank(userPassword)) { // add default user to map if password specified</span>
<span class="fc" id="L170">            addRunOnBehalfOfUsers(username, userPassword, defaultRealm);</span>
        } else {
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">            if (StringUtils.isBlank(runOnBehalfOfUsers.get(username))) {</span>
<span class="fc" id="L173">                throw new IllegalStateException(&quot;password for default user: &quot; + username + &quot; must be specified&quot;);</span>
            }
        }
<span class="fc" id="L176">    }</span>

    @Override
    public boolean isJwtBearerFilterEnable() {
<span class="fc" id="L180">        return jwtBearerFilterEnable;</span>
    }

    @Override
    public void setJwtBearerFilterEnable(boolean jwtBearerFilterEnable) {
<span class="fc" id="L185">        this.jwtBearerFilterEnable = jwtBearerFilterEnable;</span>
<span class="fc" id="L186">    }</span>

    @Override
    public boolean isJwtBearerTokenRequired() {
<span class="nc" id="L190">        return jwtBearerTokenRequired;</span>
    }

    @Override
    public void setJwtBearerTokenRequired(boolean jwtBearerTokenRequired) {
<span class="nc" id="L195">        this.jwtBearerTokenRequired = jwtBearerTokenRequired;</span>
<span class="nc" id="L196">    }</span>

    @Override
    public String getIdentityProviderHost() {
<span class="fc" id="L200">        return identityProviderHost;</span>
    }

    @Override
    public void setIdentityProviderHost(String identityProviderHost) {
<span class="fc" id="L205">        this.identityProviderHost = identityProviderHost;</span>
<span class="fc" id="L206">    }</span>

    @Override
    public String getAuthorizationEndpoint() {
<span class="fc" id="L210">        return authorizationEndpoint;</span>
    }

    @Override
    public void setAuthorizationEndpoint(String authorizationEndpoint) {
<span class="fc" id="L215">        this.authorizationEndpoint = authorizationEndpoint;</span>
<span class="fc" id="L216">    }</span>

    @Override
    public String getTokenEndpoint() {
<span class="fc" id="L220">        return tokenEndpoint;</span>
    }

    @Override
    public void setTokenEndpoint(String tokenEndpoint) {
<span class="nc" id="L225">        this.tokenEndpoint = tokenEndpoint;</span>
<span class="nc" id="L226">    }</span>

    @Override
    public String getClientId() {
<span class="fc" id="L230">        return clientId;</span>
    }

    @Override
    public void setClientId(String clientId) {
<span class="fc" id="L235">        this.clientId = clientId;</span>
<span class="fc" id="L236">    }</span>

    @Override
    public String getClientSecret() {
<span class="nc" id="L240">        return clientSecret;</span>
    }

    @Override
    public void setClientSecret(String clientSecret) {
<span class="nc" id="L245">        this.clientSecret = clientSecret;</span>
<span class="nc" id="L246">    }</span>

    @Override
    public String buildRedirectUrl(String realm, String redirectUrl) throws UnsupportedEncodingException {
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        String redirectUri =</span>
<span class="pc" id="L251">                encodeRedirectUri ? URLEncoder.encode(redirectUrl, &quot;UTF-8&quot;) : redirectUrl;</span>
<span class="fc" id="L252">        String endpointUri = replaceRealPlaceHolder(realm, authorizationEndpoint);</span>
<span class="fc" id="L253">        return identityProviderHost +</span>
                endpointUri.
<span class="fc" id="L255">                        replace(CLIENT_ID_PLACEHOLDER, clientId).</span>
<span class="fc" id="L256">                        replace(REDIRECT_URI_PLACEHOLDER, redirectUri);</span>
    }

    private String replaceRealPlaceHolder(String realm, String redirectUri) {
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        return redirectUri.replace(REALM_PLACEHOLDER, realm != null ? realm : &quot;&quot;);</span>
    }

    String buildLogoutUrl(String realm) {
<span class="nc" id="L264">        String logoutUri = this.logoutEndpoint;</span>
<span class="nc" id="L265">        logoutUri = replaceRealPlaceHolder(realm, logoutUri);</span>
<span class="nc" id="L266">        return identityProviderHost + logoutUri;</span>
    }

    @Override
    public String getScope() {
<span class="nc" id="L271">        return scope;</span>
    }

    @Override
    public void setScope(String scope) {
<span class="nc" id="L276">        this.scope = scope;</span>
<span class="nc" id="L277">    }</span>

    @Override
    public String getUsername() {
<span class="nc" id="L281">        return username;</span>
    }

    @Override
    public void setUsername(String username) {
<span class="fc" id="L286">        this.username = username;</span>
<span class="fc" id="L287">    }</span>

    @Override
    public String getUserPassword() {
<span class="nc" id="L291">        return userPassword;</span>
    }

    @Override
    public void setUserPassword(String userPassword) {
<span class="fc" id="L296">        this.userPassword = userPassword;</span>
<span class="fc" id="L297">    }</span>

    @Override
    public boolean isCheckIsActive() {
<span class="fc" id="L301">        return checkIsActive;</span>
    }

    @Override
    public void setCheckIsActive(boolean checkIsActive) {
<span class="fc" id="L306">        this.checkIsActive = checkIsActive;</span>
<span class="fc" id="L307">    }</span>

    @Override
    public boolean isCheckTokenType() {
<span class="fc" id="L311">        return checkTokenType;</span>
    }

    @Override
    public void setCheckTokenType(boolean checkTokenType) {
<span class="fc" id="L316">        this.checkTokenType = checkTokenType;</span>
<span class="fc" id="L317">    }</span>

    @Override
    public String getDefaultRealm() {
<span class="fc" id="L321">        return this.defaultRealm;</span>
    }

    @Override
    public void setDefaultRealm(String defaultRealm) {
<span class="fc" id="L326">        this.defaultRealm = defaultRealm;</span>
<span class="fc" id="L327">    }</span>

    public String getExcludeValidationRealm() {
<span class="fc" id="L330">        return excludeValidationRealm;</span>
    }

    public void setExcludeValidationRealm(String excludeValidationRealm) {
<span class="fc" id="L334">        this.excludeValidationRealm = excludeValidationRealm;</span>
<span class="fc" id="L335">    }</span>

    public boolean isUseReferAsRedirectUri() {
<span class="fc" id="L338">        return useReferAsRedirectUri;</span>
    }

    public void setUseReferAsRedirectUri(boolean useReferAsRedirectUri) {
<span class="nc" id="L342">        this.useReferAsRedirectUri = useReferAsRedirectUri;</span>
<span class="nc" id="L343">    }</span>

    public boolean isSecurityInterceptorEnable() {
<span class="nc" id="L346">        return securityInterceptorEnable;</span>
    }

    public int getTokenShouldBeRefreshed() {
<span class="nc" id="L350">        return tokenShouldBeRefreshed;</span>
    }

    public boolean isEncodeRedirectUri() {
<span class="nc" id="L354">        return encodeRedirectUri;</span>
    }

    public void setEncodeRedirectUri(boolean encodeRedirectUri) {
<span class="nc" id="L358">        this.encodeRedirectUri = encodeRedirectUri;</span>
<span class="nc" id="L359">    }</span>

    @Value(&quot;${security.oidc.AuthenticationJwtBearerTokenAwareFilter.jwtBearerTokenOtherAuthenticationAllowed:false}&quot;)
    public void setJwtBearerTokenOtherAuthenticationAllowed(boolean jwtBearerTokenOtherAuthenticationAllowed) {
<span class="fc" id="L363">        this.jwtBearerTokenOtherAuthenticationAllowed = jwtBearerTokenOtherAuthenticationAllowed;</span>
<span class="fc" id="L364">    }</span>

    public boolean isJwtBearerTokenOtherAuthenticationAllowed() {
<span class="fc" id="L367">        return jwtBearerTokenOtherAuthenticationAllowed;</span>
    }

    public String getRunOnBehalfOfUserPassword(String username, String realm) {
<span class="fc" id="L371">        UserKey userKey = new UserKey(username, realm);</span>
<span class="fc" id="L372">        return runOnBehalfOfUsers.get(userKey);</span>
    }

    public Map&lt;UserKey, String&gt; getRunOnBehalfOfUsers() {
<span class="fc" id="L376">        return Collections.unmodifiableMap(runOnBehalfOfUsers);</span>
    }

    public void addRunOnBehalfOfUsers(String username, String userPassword, String realm){
<span class="fc" id="L380">        UserKey userKey = new UserKey(username, realm);</span>
<span class="fc" id="L381">        logger.info(&quot;added credentials to run on behalf for user: {}&quot;, userKey);</span>
<span class="fc" id="L382">        runOnBehalfOfUsers.put(userKey, userPassword);</span>
<span class="fc" id="L383">    }</span>

    /**
     * Sets runOnBehalf user for exact realm
     * @param credentials format login:password@realm (e.g. admin:wtqwerty@test-qa-rc)
     */
    @Override
    @Value(&quot;${security.oauth2.runOnBehalfOfUser:}&quot;)
    public void setRunOnBehalfOfUsers(String credentials) {
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (StringUtils.isBlank(credentials)) {</span>
<span class="fc" id="L393">            return;</span>
        }
<span class="fc" id="L395">        String[] usersCredentials = credentials.split(&quot;,&quot;);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        for (String usersCredential: usersCredentials) {</span>
<span class="fc" id="L397">            addUserToRunOnBehalfMap(usersCredential);</span>
        }
<span class="fc" id="L399">    }</span>

    void addUserToRunOnBehalfMap(String usersCredential) {
<span class="fc" id="L402">        String[] credAndRealm = usersCredential.split(&quot;@&quot;);</span>
<span class="fc" id="L403">        String[] cred = credAndRealm[0].split(&quot;:&quot;);</span>
<span class="pc bpc" id="L404" title="1 of 4 branches missed.">        if (credAndRealm.length != 2 || cred.length != 2) {</span>
<span class="fc" id="L405">            logger.warn(&quot;Could not parse usersCredential: {}&quot;, usersCredential);</span>
<span class="fc" id="L406">            return;</span>
        }
<span class="fc" id="L408">        String realm = credAndRealm[1];</span>
<span class="fc" id="L409">        String login = cred[0];</span>
<span class="fc" id="L410">        String password = cred[1];</span>
<span class="pc bpc" id="L411" title="3 of 6 branches missed.">        if (StringUtils.isBlank(realm) || StringUtils.isBlank(login) || StringUtils.isBlank(password)) {</span>
<span class="nc" id="L412">            logger.warn(&quot;Some login:password@realm is empty in usersCredential: {}&quot;, usersCredential);</span>
<span class="nc" id="L413">            return;</span>
        }
<span class="fc" id="L415">        addRunOnBehalfOfUsers(login.trim(), password.trim(), realm.trim());</span>
<span class="fc" id="L416">    }</span>

    public boolean isAnonymousAllowed() {
<span class="nc" id="L419">        return anonymousAllowed;</span>
    }

    public void setAnonymousAllowed(boolean anonymousAllowed) {
<span class="nc" id="L423">        this.anonymousAllowed = anonymousAllowed;</span>
<span class="nc" id="L424">    }</span>

    public boolean isSkipRefererCheck() {
<span class="nc" id="L427">        return skipRefererCheck;</span>
    }

    public void setSkipRefererCheck(boolean skipRefererCheck) {
<span class="nc" id="L431">        this.skipRefererCheck = skipRefererCheck;</span>
<span class="nc" id="L432">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L436">        return &quot;OidcConfiguration{&quot; +</span>
                &quot;identityProviderHost='&quot; + identityProviderHost + '\'' +
                &quot;, authorizationEndpoint='&quot; + authorizationEndpoint + '\'' +
                &quot;, logoutEndpoint='&quot; + logoutEndpoint + '\'' +
                &quot;, tokenEndpoint='&quot; + tokenEndpoint + '\'' +
                &quot;, clientId='&quot; + clientId + '\'' +
<span class="nc" id="L442">                &quot;, clientSecret='&quot; + StringUtils.getMaskedString(clientSecret) + '\'' +</span>
                &quot;, username='&quot; + username + '\'' +
                &quot;, scope='&quot; + scope + '\'' +
                &quot;, checkIsActive=&quot; + checkIsActive +
                &quot;, checkTokenType=&quot; + checkTokenType +
                &quot;, useReferAsRedirectUri=&quot; + useReferAsRedirectUri +
                &quot;, defaultRealm='&quot; + defaultRealm + '\'' +
                &quot;, excludeValidationRealm='&quot; + excludeValidationRealm + '\'' +
                &quot;, tokenShouldBeRefreshed=&quot; + tokenShouldBeRefreshed +
                &quot;, securityInterceptorEnable=&quot; + securityInterceptorEnable +
<span class="nc" id="L452">                &quot;, urlResolver='&quot; + urlResolver.toString()+ '\'' +</span>
<span class="nc" id="L453">                &quot;, filterApplyUrlPattern=&quot; + interceptorUrlResolver.toString()+</span>
                &quot;, jwtBearerFilterEnable=&quot; + jwtBearerFilterEnable  + '\'' +
                &quot;, jwtBearerTokenRequired=&quot; + jwtBearerTokenRequired  + '\'' +
                &quot;, encodeRedirectUri=&quot; + encodeRedirectUri  + '\'' +
                &quot;, anonymousAllowed=&quot; + anonymousAllowed  + '\'' +
                &quot;, skipRefererCheck=&quot; + skipRefererCheck  + '\'' +
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>