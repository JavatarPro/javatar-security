<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuthenticationJwtBearerTokenAwareFilter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">security-filter</a> &gt; <a href="index.source.html" class="el_package">pro.javatar.security.oidc.filters</a> &gt; <span class="el_source">AuthenticationJwtBearerTokenAwareFilter.java</span></div><h1>AuthenticationJwtBearerTokenAwareFilter.java</h1><pre class="source lang-java linenums">package pro.javatar.security.oidc.filters;

import static pro.javatar.security.oidc.model.OAuth2Constants.ACCESS_TOKEN;
import static pro.javatar.security.oidc.model.OAuth2Constants.REFRESH_TOKEN;

import pro.javatar.security.oidc.model.OAuth2Constants;
import pro.javatar.security.jwt.TokenVerifier;
import pro.javatar.security.oidc.model.TokenDetails;
import pro.javatar.security.oidc.SecurityConstants;
import pro.javatar.security.oidc.exceptions.BearerJwtTokenNotFoundAuthenticationException;
import pro.javatar.security.oidc.exceptions.ExchangeTokenByCodeAuthenticationException;
import pro.javatar.security.oidc.exceptions.ExpiredAuthenticationSessionException;
import pro.javatar.security.oidc.exceptions.ObtainRefreshTokenException;
import pro.javatar.security.oidc.services.OAuth2AuthorizationFlowService;
import pro.javatar.security.oidc.services.OidcAuthenticationHelper;
import pro.javatar.security.oidc.services.OidcConfiguration;
import pro.javatar.security.oidc.utils.StringUtils;

import org.apache.http.HttpHeaders;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpRequest;
import org.springframework.http.server.ServletServerHttpRequest;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import java.io.IOException;

/**
 * This filter authenticate and authorize user by bearer token or by authorization code.
 * Please see rfc6749, rfc6750 for more details.
 */
@Component
<span class="fc" id="L45">public class AuthenticationJwtBearerTokenAwareFilter implements Filter {</span>
<span class="fc" id="L46">    private static final Logger logger =</span>
<span class="fc" id="L47">            LoggerFactory.getLogger(AuthenticationJwtBearerTokenAwareFilter.class);</span>
    public static final String DIGEST_AUTHORIZATION_HEADER = &quot;Digest&quot;;
    public static final String BASIC_AUTHORIZATION_HEADER = &quot;Basic&quot;;

    private OidcConfiguration oidcConfiguration;

    // TODO (bzo) ask configuration about is filter enable/disable
    private AuthorizationStubFilter authorizationStubFilter;

    private OAuth2AuthorizationFlowService auth2AuthorizationFlowService;

    private OidcAuthenticationHelper oidcHelper;

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
<span class="fc" id="L62">        logger.info(AuthenticationJwtBearerTokenAwareFilter.class.getName() + &quot; initialized&quot;);</span>
<span class="fc" id="L63">    }</span>

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse,
                         FilterChain filterChain) throws IOException, ServletException {
<span class="fc" id="L68">        boolean stubFilterEnable = authorizationStubFilter.isFilterEnable();</span>
<span class="pc bpc" id="L69" title="2 of 4 branches missed.">        if (!oidcConfiguration.isJwtBearerFilterEnable() || stubFilterEnable) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            logger.info(&quot;{} is disabled. Dev mode is {}.&quot;, getClass().getCanonicalName(),</span>
                    stubFilterEnable ? &quot;on&quot; : &quot;off&quot;);
<span class="nc" id="L72">            filterChain.doFilter(servletRequest, servletResponse);</span>
<span class="nc" id="L73">            return;</span>
        }

<span class="fc" id="L76">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span>
<span class="fc" id="L77">        HttpServletResponse response = (HttpServletResponse) servletResponse;</span>

<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        if (shouldSkip(request)) {</span>
<span class="nc" id="L80">            logger.debug(&quot;Filter was skipped by filter condition.&quot;);</span>
<span class="nc" id="L81">            filterChain.doFilter(servletRequest, servletResponse);</span>
<span class="nc" id="L82">            return;</span>
        }

<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        if (isOtherAuthenticaticationAllowed()) {</span>
<span class="nc" id="L86">            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">            if (authentication != null &amp;&amp; authentication.isAuthenticated()) {</span>
<span class="nc" id="L88">                logger.info(&quot;authentication was obtained by other method&quot;);</span>
<span class="nc" id="L89">                filterChain.doFilter(servletRequest, servletResponse);</span>
<span class="nc" id="L90">                return;</span>
            }
        }

        try {
<span class="fc" id="L95">            authenticate(request, response);</span>
<span class="fc" id="L96">            filterChain.doFilter(servletRequest, servletResponse);</span>
        } finally {
<span class="fc" id="L98">            oidcHelper.safeCleanupSecurityContext(AuthenticationJwtBearerTokenAwareFilter.class);</span>
<span class="fc" id="L99">        }</span>
<span class="fc" id="L100">    }</span>

    @Override
    public void destroy() {
<span class="fc" id="L104">        logger.info(&quot;AuthenticationJwtBearerTokenAwareFilter destroyed&quot;);</span>
<span class="fc" id="L105">    }</span>

    boolean shouldSkip(ServletRequest request) {
<span class="fc" id="L108">        return shouldSkip(new ServletServerHttpRequest((HttpServletRequest) request));</span>
    }

    /**
     * If necessary, the method can be redefined
     *
     * @param request
     * @return &lt;code&gt;true&lt;/code&gt; filter is ignored
     */
    boolean shouldSkip(HttpRequest request) {
<span class="fc" id="L118">        return oidcHelper.shouldSkip(request);</span>
    }

    void authenticate(HttpServletRequest request, HttpServletResponse response) {
<span class="fc" id="L122">        TokenDetails tokenDetails = obtainJwtBearerToken(request);</span>
<span class="pc bpc" id="L123" title="3 of 4 branches missed.">        if (tokenDetails == null &amp;&amp; oidcConfiguration.isAnonymousAllowed()) {</span>
<span class="nc" id="L124">            logger.debug(&quot;skipping authentication bearer token not found but anonymous is allowed&quot;);</span>
<span class="nc" id="L125">            return;</span>
        }
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        if (tokenDetails == null) {</span>
<span class="nc" id="L128">            logger.warn(&quot;Did not obtain token from request.&quot;);</span>
<span class="nc" id="L129">            return;</span>
        }
<span class="fc" id="L131">        tokenDetails.setCredentialsProvider(AuthenticationJwtBearerTokenAwareFilter.class);</span>
<span class="fc" id="L132">        String tokenRealm = TokenVerifier.getRealm(tokenDetails.getAccessToken());</span>
<span class="fc" id="L133">        tokenDetails.setRealm(tokenRealm);</span>
<span class="fc" id="L134">        oidcHelper.validateRealm(tokenDetails);</span>
<span class="fc" id="L135">        oidcHelper.authenticateCurrentThread(tokenDetails);</span>
<span class="fc" id="L136">        setupAuthorizationHeader(response, tokenDetails);</span>
<span class="fc" id="L137">    }</span>


    void setupAuthorizationHeader(HttpServletResponse response, TokenDetails tokenDetails) {
<span class="fc" id="L141">        logger.info(&quot;Setup authorization/refresh tokens&quot;);</span>
<span class="fc" id="L142">        response.addHeader(HttpHeaders.AUTHORIZATION,</span>
<span class="fc" id="L143">                OidcAuthenticationHelper.AUTH_HEADER_VALUE_PREFIX + tokenDetails.getAccessToken());</span>
<span class="fc" id="L144">        String refreshToken = tokenDetails.getRefreshToken();</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        response.addHeader(SecurityConstants.REFRESH_TOKEN_HEADER, StringUtils.isNotBlank(refreshToken) ?</span>
                refreshToken :
                &quot;&quot;);
<span class="fc" id="L148">    }</span>

    TokenDetails obtainJwtBearerToken(HttpServletRequest request) throws BearerJwtTokenNotFoundAuthenticationException {
<span class="fc bfc" id="L151" title="All 2 branches covered.">        if (isHeaderTokenPresent(request)) {</span>
<span class="fc" id="L152">            return oidcHelper.generateTokenDetails(oidcHelper.getBearerToken(request), oidcHelper.getRefreshToken(request));</span>
        }

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (isAuthorizationCodePresent(request) &amp;&amp;</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                isAuthorizationCodePassedByIdentityProvider(request)) {</span>
<span class="nc" id="L157">            return exchangeAuthorizationCodeForBearerToken(request);</span>
        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (oidcConfiguration.isAnonymousAllowed()) {</span>
<span class="nc" id="L160">            return null;</span>
        } else {
<span class="nc" id="L162">            throw new BearerJwtTokenNotFoundAuthenticationException();</span>
        }
    }

    TokenDetails exchangeAuthorizationCodeForBearerToken(HttpServletRequest request)
            throws ExchangeTokenByCodeAuthenticationException {
<span class="fc" id="L168">        String secureCode = request.getParameter(OAuth2Constants.CODE);</span>
        try {
<span class="fc" id="L170">            String redirectUrl = request.getRequestURL().toString();</span>
<span class="fc" id="L171">            String referer = request.getHeader(SecurityConstants.REFERER_HEADER);</span>
<span class="pc bpc" id="L172" title="3 of 4 branches missed.">            if (oidcConfiguration.isUseReferAsRedirectUri() &amp;&amp; StringUtils.isNotBlank(referer)) {</span>
<span class="nc" id="L173">                redirectUrl = referer;</span>
            }
<span class="fc" id="L175">            redirectUrl = oidcHelper.removeCodeFromUrl(redirectUrl, secureCode);</span>
<span class="nc" id="L176">            return auth2AuthorizationFlowService.getTokenDetailsByCode(secureCode, redirectUrl);</span>
<span class="fc" id="L177">        } catch (Exception e) {</span>
<span class="fc" id="L178">            logger.error(&quot;Error during obtaining access token by authorization code:&quot;, e);</span>
<span class="fc" id="L179">            ExchangeTokenByCodeAuthenticationException exchangeTokenByCodeAuthenticationException =</span>
                    new ExchangeTokenByCodeAuthenticationException();
<span class="fc" id="L181">            exchangeTokenByCodeAuthenticationException.setDevMessage(e.getMessage());</span>
<span class="fc" id="L182">            throw exchangeTokenByCodeAuthenticationException;</span>
        }
    }

    boolean isAuthorizationCodePresent(HttpServletRequest request) {
<span class="fc" id="L187">        return StringUtils.isNotBlank(request.getParameter(OAuth2Constants.CODE));</span>
    }

    boolean isHeaderTokenPresent(HttpServletRequest request) {
<span class="fc" id="L191">        String token = oidcHelper.getBearerToken(request);</span>
<span class="fc bfc" id="L192" title="All 4 branches covered.">        return StringUtils.isNotBlank(token) &amp;&amp; !token.startsWith(DIGEST_AUTHORIZATION_HEADER)</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">                &amp;&amp; !token.startsWith(BASIC_AUTHORIZATION_HEADER);</span>
    }

    boolean isOtherAuthenticaticationAllowed() {
<span class="fc" id="L197">        return oidcConfiguration.isJwtBearerTokenOtherAuthenticationAllowed();</span>
    }

    private boolean isAuthorizationCodePassedByIdentityProvider(HttpServletRequest request) {
<span class="fc" id="L201">        String referrer = request.getHeader(SecurityConstants.REFERER_HEADER);</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (StringUtils.isBlank(oidcConfiguration.getIdentityProviderHost())) {</span>
<span class="fc" id="L203">            logger.warn(&quot;IdentityProviderHost not set&quot;);</span>
<span class="fc" id="L204">            return true;</span>
        }
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if(oidcConfiguration.isSkipRefererCheck()){</span>
<span class="nc" id="L207">            logger.debug(&quot;Skipping referer check.&quot;);</span>
<span class="nc" id="L208">            return true;</span>
        }
<span class="nc" id="L210">        boolean refererPresent = StringUtils.isNotBlank(referrer);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        logger.info(&quot;Referer is &quot; + (refererPresent ? &quot;present&quot; : &quot; NOT present&quot; + &quot; in headers.&quot;));</span>
<span class="nc" id="L212">        return refererPresent;</span>
    }

    @Autowired
    public void setAuth2AuthorizationFlowService(OAuth2AuthorizationFlowService auth2AuthorizationFlowService) {
<span class="fc" id="L217">        this.auth2AuthorizationFlowService = auth2AuthorizationFlowService;</span>
<span class="fc" id="L218">    }</span>

    @Autowired
    public void setOidcHelper(OidcAuthenticationHelper oidcHelper) {
<span class="fc" id="L222">        this.oidcHelper = oidcHelper;</span>
<span class="fc" id="L223">    }</span>

    @Autowired
    public void setAuthorizationStubFilter(AuthorizationStubFilter authorizationStubFilter) {
<span class="fc" id="L227">        this.authorizationStubFilter = authorizationStubFilter;</span>
<span class="fc" id="L228">    }</span>

    @Autowired
    public void setOidcConfiguration(OidcConfiguration oidcConfiguration) {
<span class="fc" id="L232">        this.oidcConfiguration = oidcConfiguration;</span>
<span class="fc" id="L233">    }</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>