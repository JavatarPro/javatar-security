<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuthenticationRealmAwareFilter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">security-filter</a> &gt; <a href="index.source.html" class="el_package">pro.javatar.security.oidc.filters</a> &gt; <span class="el_source">AuthenticationRealmAwareFilter.java</span></div><h1>AuthenticationRealmAwareFilter.java</h1><pre class="source lang-java linenums">package pro.javatar.security.oidc.filters;

import pro.javatar.security.oidc.SecurityConstants;
import pro.javatar.security.oidc.exceptions.RealmNotFoundAuthenticationException;
import pro.javatar.security.oidc.services.FilterOptionConverter;
import pro.javatar.security.oidc.services.OidcAuthenticationHelper;
import pro.javatar.security.oidc.utils.StringUtils;
import pro.javatar.security.oidc.utils.UrlResolver;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpRequest;
import org.springframework.http.server.ServletServerHttpRequest;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * This filter aims to retrieve realm from request and setup it for current thread.
 * There are three places where realm is expected: header, url or query parameter.
 * If realm is mandatory and not provided RealmNotFoundAuthenticationException will be thrown.
 * You can check realmMandatory variable (security.oidc.AuthenticationRealmAwareFilter.isRealmMandatory),
 * default value is true.
 * This filter could be enable by setting enableFilter (security.oidc.AuthenticationRealmAwareFilter.enable) to true.
 * By default filter is enabled.
 * Please provide filterApplyUrlRegex (security.oidc.AuthenticationRealmAwareFilter.filterApplyUrlRegex)
 * or default (security.oidc.filterApplyUrlRegex) will be used otherwise.
 */
@Component
public class AuthenticationRealmAwareFilter implements Filter {

    public static final String BASE_REALM_REGEX = &quot;(.*)&quot;;
<span class="fc" id="L48">    private static final Logger logger =</span>
<span class="fc" id="L49">            LoggerFactory.getLogger(AuthenticationRealmAwareFilter.class);</span>
    private static final String REALM_PLACEHOLDER = &quot;{realm}&quot;;

<span class="fc" id="L52">    private boolean enableFilter = false;</span>

    private String realmUrlPattern;

    private String realmParamName;

    private boolean realmMandatory;

    private Pattern urlPattern;

    private final OidcAuthenticationHelper oidcAuthenticationHelper;
<span class="fc" id="L63">    private final FilterOptionConverter filterOptionConverter = new FilterOptionConverter();</span>
<span class="fc" id="L64">    private final UrlResolver urlResolver = new UrlResolver();</span>

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
<span class="fc" id="L68">        logger.info(&quot;init filter: {}&quot;, AuthenticationRealmAwareFilter.class);</span>
<span class="fc" id="L69">    }</span>

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)
            throws IOException, ServletException {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (!enableFilter) {</span>
<span class="fc" id="L75">            logger.info(&quot;{} is disabled&quot;, getClass().getCanonicalName());</span>
<span class="fc" id="L76">            filterChain.doFilter(servletRequest, servletResponse);</span>
<span class="fc" id="L77">            return;</span>
        }

<span class="fc" id="L80">        oidcAuthenticationHelper.removeRealmFromCurrentRequest();</span>
<span class="fc" id="L81">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (shouldSkip(new ServletServerHttpRequest(request))) {</span>
<span class="fc" id="L84">            logger.info(&quot;{} {} is skipped&quot;, request.getMethod(), request.getRequestURI());</span>
<span class="fc" id="L85">            filterChain.doFilter(servletRequest, servletResponse);</span>
<span class="fc" id="L86">            return;</span>
        }

<span class="fc" id="L89">        logger.info(&quot;setup realm for current request&quot;);</span>
<span class="fc" id="L90">        setupRealmForCurrentRequestThread(request);</span>
<span class="fc" id="L91">        validateRealmSetup();</span>
<span class="fc" id="L92">        setupRealmInResponse(servletResponse);</span>

        try {
<span class="fc" id="L95">            filterChain.doFilter(servletRequest, servletResponse);</span>
        } finally {
<span class="fc" id="L97">            logger.info(&quot;clean up realm from current request&quot;);</span>
<span class="fc" id="L98">            oidcAuthenticationHelper.removeRealmFromCurrentRequest();</span>
<span class="fc" id="L99">            cleanupSecurityContextForCurrentThread();</span>
<span class="fc" id="L100">        }</span>
<span class="fc" id="L101">    }</span>

    @Override
    public void destroy() {
<span class="fc" id="L105">    }</span>

    void setupRealmInResponse(ServletResponse servletResponse) {
<span class="fc" id="L108">        HttpServletResponse response = (HttpServletResponse) servletResponse;</span>
<span class="fc" id="L109">        String realm = oidcAuthenticationHelper.getRealmForCurrentRequest();</span>
<span class="fc" id="L110">        response.setHeader(SecurityConstants.REALM_HEADER, realm);</span>
<span class="fc" id="L111">    }</span>

    void setupRealmForCurrentRequestThread(HttpServletRequest request) {
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (containsRealmHeader(request)) {</span>
<span class="fc" id="L115">            setupRealmFromHeader(request);</span>
<span class="fc" id="L116">            return;</span>
        }

<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (isUrlRetrieverEnabled()) {</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (isSuccessfulSetupRealmFromUri(request))</span>
<span class="fc" id="L121">                return;</span>
        }

<span class="fc" id="L124">        setupRealmFromParams(request);</span>
<span class="fc" id="L125">    }</span>

    void validateRealmSetup() {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (!realmMandatory)</span>
<span class="fc" id="L129">            return;</span>
<span class="fc" id="L130">        String realm = oidcAuthenticationHelper.getRealmForCurrentRequest();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (StringUtils.isBlank(realm)) {</span>
<span class="fc" id="L132">            logger.warn(&quot;validate realm fails, it is mandatory&quot;);</span>
<span class="fc" id="L133">            throw new RealmNotFoundAuthenticationException();</span>
        }
<span class="fc" id="L135">    }</span>

    boolean containsRealmHeader(HttpServletRequest request) {
<span class="fc" id="L138">        String realm = request.getHeader(SecurityConstants.REALM_HEADER);</span>
<span class="fc" id="L139">        return StringUtils.isNotBlank(realm);</span>
    }

    void setupRealmFromHeader(HttpServletRequest request) {
<span class="fc" id="L143">        String realm = request.getHeader(SecurityConstants.REALM_HEADER);</span>
<span class="fc" id="L144">        oidcAuthenticationHelper.setRealmForCurrentRequest(realm);</span>
<span class="fc" id="L145">    }</span>

    boolean isUrlRetrieverEnabled() {
<span class="fc bfc" id="L148" title="All 2 branches covered.">        return urlPattern != null;</span>
    }

    boolean isSuccessfulSetupRealmFromUri(HttpServletRequest request) {
<span class="fc" id="L152">        String url = request.getRequestURI();</span>
<span class="fc" id="L153">        String realm = retrieveRealmFromUrl(url);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (StringUtils.isBlank(realm))</span>
<span class="fc" id="L155">            return false;</span>
<span class="fc" id="L156">        logger.info(&quot;realm: {} was retrieved from url: {}&quot;, realm, url);</span>
<span class="fc" id="L157">        oidcAuthenticationHelper.setRealmForCurrentRequest(realm);</span>
<span class="fc" id="L158">        return true;</span>
    }

    void setupRealmFromParams(HttpServletRequest request) {
<span class="fc" id="L162">        String realm = request.getParameter(realmParamName);</span>
<span class="fc" id="L163">        oidcAuthenticationHelper.setRealmForCurrentRequest(realm);</span>
<span class="fc" id="L164">    }</span>

    String prepareRealmRegex(String realmUrlPattern) {
<span class="fc" id="L167">        String realmRegex = BASE_REALM_REGEX;</span>
<span class="fc" id="L168">        int lastIndex = realmUrlPattern.lastIndexOf('}');</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (lastIndex != (realmUrlPattern.length() - 1)) {</span>
<span class="fc" id="L170">            char lastChar = realmUrlPattern.charAt(lastIndex + 1);</span>
<span class="fc" id="L171">            realmRegex = &quot;([^&quot; + lastChar + &quot;]{2,})&quot;;</span>
        }
<span class="fc" id="L173">        return realmRegex;</span>
    }

    boolean shouldSkip(ServletRequest request) {
<span class="nc" id="L177">        return shouldSkip(new ServletServerHttpRequest((HttpServletRequest) request));</span>
    }

    /**
     * If necessary, the method can be redefined
     *
     * @return &lt;code&gt;true&lt;/code&gt; filter is ignored
     * @param request
     */
    boolean shouldSkip(HttpRequest request) {
<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (!urlResolver.isEmpty()) {</span>
<span class="fc" id="L188">            return urlResolver.skip(request);</span>
        }
<span class="fc" id="L190">        return oidcAuthenticationHelper.shouldSkip(request);</span>
    }

    private String retrieveRealmFromUrl(String url) {
<span class="fc" id="L194">        Matcher matcher = urlPattern.matcher(url);</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (matcher.find()) {</span>
<span class="fc" id="L196">            return matcher.group(1);</span>
        }
<span class="fc" id="L198">        return null;</span>
    }

    private void cleanupSecurityContextForCurrentThread() {
<span class="fc" id="L202">        SecurityContextHolder.clearContext();</span>
<span class="fc" id="L203">    }</span>

    @Value(&quot;${security.oidc.AuthenticationRealmAwareFilter.enable:true}&quot;)
    public void setEnableFilter(boolean enableFilter) {
<span class="fc" id="L207">        this.enableFilter = enableFilter;</span>
<span class="fc" id="L208">    }</span>

    @Value(&quot;${security.oidc.AuthenticationRealmAwareFilter.realmUrlPattern:}&quot;)
    public void setRealmUrlPattern(String realmUrlPattern) {
<span class="fc" id="L212">        this.realmUrlPattern = realmUrlPattern;</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (StringUtils.isNotBlank(realmUrlPattern)</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                &amp;&amp; realmUrlPattern.contains(REALM_PLACEHOLDER)) {</span>
<span class="fc" id="L215">            urlPattern = Pattern.compile(realmUrlPattern.replace(REALM_PLACEHOLDER,</span>
<span class="fc" id="L216">                    prepareRealmRegex(realmUrlPattern)), Pattern.CASE_INSENSITIVE);</span>
        }
<span class="fc" id="L218">    }</span>

    @Value(&quot;${security.oidc.AuthenticationRealmAwareFilter.filterApplyUrlRegex:}&quot;)
    public void setFilterApplyUrlRegex(String filterApplyUrlRegex) {
<span class="fc" id="L222">        urlResolver.setFilterApplyUrlRegex(filterApplyUrlRegex);</span>
<span class="fc" id="L223">    }</span>

    @Value(&quot;${security.oidc.AuthenticationRealmAwareFilter.realmParamName:realm}&quot;)
    public void setRealmParamName(String realmParamName) {
<span class="fc" id="L227">        this.realmParamName = realmParamName;</span>
<span class="fc" id="L228">    }</span>

    @Value(&quot;${security.oidc.AuthenticationRealmAwareFilter.isRealmMandatory:true}&quot;)
    public void setRealmMandatory(boolean realmMandatory) {
<span class="fc" id="L232">        this.realmMandatory = realmMandatory;</span>
<span class="fc" id="L233">    }</span>

    @Value(&quot;#{'${security.oidc.AuthenticationRealmAwareFilter.filterApplyUrlList:}'.split(',')}&quot;)
    public void setFilterApplyUrlList(List&lt;String&gt; filterApplyUrlList) {
<span class="fc" id="L237">        urlResolver.setFilterApplyUrls(filterOptionConverter.convertList(filterApplyUrlList));</span>
<span class="fc" id="L238">    }</span>

    @Value(&quot;#{'${security.oidc.AuthenticationRealmAwareFilter.filterIgnoreUrlList:}'.split(',')}&quot;)
    public void setFilterIgnoreUrls(List&lt;String&gt; filterIgnoreUrlList) {
<span class="fc" id="L242">        urlResolver.setFilterIgnoreUrls(filterOptionConverter.convertList(filterIgnoreUrlList));</span>
<span class="fc" id="L243">    }</span>

    @Autowired
<span class="fc" id="L246">    public AuthenticationRealmAwareFilter(OidcAuthenticationHelper oidcAuthenticationHelper) {</span>
<span class="fc" id="L247">        this.oidcAuthenticationHelper = oidcAuthenticationHelper;</span>
<span class="fc" id="L248">    }</span>

    @Override
    public String toString() {
<span class="fc" id="L252">        return &quot;AuthenticationRealmAwareFilter{&quot; +</span>
                &quot;enableFilter=&quot; + enableFilter +
                &quot;, realmUrlPattern='&quot; + realmUrlPattern + '\'' +
<span class="fc" id="L255">                &quot;, urlResolver='&quot; + urlResolver.toString() + '\'' +</span>
                &quot;, realmParamName='&quot; + realmParamName + '\'' +
                &quot;, realmMandatory=&quot; + realmMandatory +
                &quot;, urlPattern=&quot; + urlPattern +
                &quot;, oidcAuthenticationHelper=&quot; + oidcAuthenticationHelper +
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>